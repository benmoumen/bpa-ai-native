// Prisma Schema for BPA AI-Native
// Database: PostgreSQL
// ORM: Prisma 7.x
//
// Naming Conventions:
// - Models: PascalCase (User, Session)
// - Tables: snake_case via @@map("table_name")
// - Fields: camelCase in TypeScript
// - Columns: snake_case via @map("column_name")

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // Note: Connection URL is configured in prisma.config.ts
  // For local development, set DATABASE_URL in .env
}

// =============================================================================
// Enums
// =============================================================================

/// ServiceStatus enum - tracks the lifecycle state of a service
enum ServiceStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

/// CostType enum - defines how cost amounts are calculated
enum CostType {
  FIXED   // Fixed amount specified directly
  FORMULA // Calculated using JSONata expression
}

// =============================================================================
// User & Authentication Models
// =============================================================================

/// User model - represents authenticated users from Keycloak
model User {
  id         String    @id @default(cuid())
  email      String    @unique
  name       String?
  keycloakId String    @unique @map("keycloak_id")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  sessions   Session[]
  services   Service[]

  @@map("users")
}

/// Session model - tracks active user sessions
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// =============================================================================
// Service Models
// =============================================================================

/// Service model - represents a configurable government service
model Service {
  id          String        @id @default(cuid())
  name        String        @db.VarChar(255)
  description String?       @db.Text
  category    String?       @db.VarChar(100)
  status      ServiceStatus @default(DRAFT)
  createdBy   String        @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  creator       User           @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  registrations Registration[]

  // Indexes for common query patterns (NFR4: service list < 1s)
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@map("services")
}

// =============================================================================
// Template Models
// =============================================================================

/// ServiceTemplate model - pre-defined service templates for quick-start creation
/// Templates contain placeholder configurations that become functional as form/workflow features are added
model ServiceTemplate {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  category        String   @db.VarChar(100)
  previewImageUrl String?  @map("preview_image_url") @db.VarChar(500)

  // Metadata computed from config (placeholder counts for Phase 1)
  formCount       Int      @default(0) @map("form_count")
  workflowSteps   Int      @default(0) @map("workflow_steps")

  // Template configuration stored as JSON
  // Structure: { forms: [], workflow: { steps: [] } }
  config          Json     @default("{}")

  // System fields
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([isActive])
  @@map("service_templates")
}

// =============================================================================
// Registration Models
// =============================================================================

/// Registration model - represents an authorization type within a service
/// (e.g., permit, license, certificate that applicants apply for)
model Registration {
  id          String   @id @default(cuid())
  serviceId   String   @map("service_id")
  name        String   @db.VarChar(100)
  shortName   String   @db.VarChar(20) @map("short_name")
  key         String   @db.VarChar(50)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  service              Service               @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  documentRequirements DocumentRequirement[]
  costs                Cost[]

  // Compound unique: key must be unique within each service
  @@unique([serviceId, key])
  @@index([serviceId])
  @@index([isActive])
  @@map("registrations")
}

// =============================================================================
// Requirement & Cost Models
// =============================================================================

/// Requirement model - global document type definitions (reusable templates)
model Requirement {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(100)
  tooltip   String?  @db.Text
  template  String?  @db.VarChar(500) // Document template reference
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  documentRequirements DocumentRequirement[]

  @@index([isActive])
  @@map("requirements")
}

/// DocumentRequirement model - links global Requirements to specific Registrations
model DocumentRequirement {
  id             String   @id @default(cuid())
  registrationId String   @map("registration_id")
  requirementId  String   @map("requirement_id")
  nameOverride   String?  @db.VarChar(100) @map("name_override")
  isRequired     Boolean  @default(true) @map("is_required")
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  requirement  Requirement  @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  // Each requirement can only be added once per registration
  @@unique([registrationId, requirementId])
  @@index([registrationId])
  @@index([requirementId])
  @@map("document_requirements")
}

/// Cost model - registration-specific fees with FIXED or FORMULA types
model Cost {
  id             String   @id @default(cuid())
  registrationId String   @map("registration_id")
  name           String   @db.VarChar(100)
  type           CostType
  fixedAmount    Decimal? @map("fixed_amount") @db.Decimal(10, 2)
  formula        String?  @db.Text // JSONata expression for calculated costs
  currency       String   @default("USD") @db.VarChar(3)
  sortOrder      Int      @default(0) @map("sort_order")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@index([registrationId])
  @@index([isActive])
  @@map("costs")
}
